<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACUARIO VALPARA칈SO POS</title>
    <!-- Librer칤as de producci칩n ultra-r치pidas para GitHub -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            background-color: #f1f5f9; 
            margin: 0;
            user-select: none;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-fade { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .product-card { height: 115px; transition: all 0.2s; }
        .product-card:active { transform: scale(0.96); }
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- ESTILOS DE IMPRESI칍N FORMATO BOLETA --- */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; overflow: visible !important; }
            #root { height: auto !important; }
            .ticket-print {
                display: block !important;
                width: 80mm;
                margin: 0 auto;
                padding: 5mm;
                color: black;
                font-family: 'Courier New', Courier, monospace;
            }
            .ticket-header { text-align: center; border-bottom: 1px dashed black; padding-bottom: 3mm; margin-bottom: 3mm; }
            .ticket-row { display: flex; justify-content: space-between; font-size: 9pt; margin-bottom: 1.5mm; }
            .ticket-total { border-top: 1px dashed black; margin-top: 3mm; padding-top: 3mm; font-weight: bold; font-size: 11pt; }
            .ticket-footer { text-align: center; margin-top: 5mm; font-size: 8pt; border-top: 1px solid black; padding-top: 2mm; }
        }
        .ticket-print { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useMemo } = React;

        // --- ICONOS ORIGINALES + NUEVOS ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                Waves: React.createElement('path', { d: "M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1" }),
                ShoppingCart: React.createElement('path', { d: "m3 3 3 .5m0 0L8 13h10l2-7H6.5M16 19a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM9 19a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" }),
                Compass: React.createElement('g', null, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('path', { d: "m16.2 7.8-2 7.4-7.4 2 2-7.4 7.4-2Z" })),
                History: React.createElement('g', null, React.createElement('path', { d: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 0V3m0 5h5" }), React.createElement('path', { d: "M12 7v5l4 2" })),
                BarChart3: React.createElement('path', { d: "M3 20h18M7 16V8M11 16V4M15 16V10M19 16v-4" }),
                Trash2: React.createElement('path', { d: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" }),
                Search: React.createElement('g', null, React.createElement('circle', { cx: "11", cy: "11", r: "8" }), React.createElement('path', { d: "m21 21-4.3-4.3" })),
                Ticket: React.createElement('path', { d: "M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" }),
                Gift: React.createElement('path', { d: "M20 12v10H4V12M2 7h20v5H2V7Zm10 15V7m0 0a3 3 0 1 0-3-3m3 3a3 3 0 1 1 3-3" }),
                Utensils: React.createElement('g', null, React.createElement('path', { d: "M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2" }), React.createElement('path', { d: "M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" })),
                X: React.createElement('path', { d: "M18 6 6 18M6 6l12 12" }),
                Plus: React.createElement('path', { d: "M12 5v14M5 12h14" }),
                Minus: React.createElement('path', { d: "M5 12h14" }),
                Book: React.createElement('path', { d: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V4H6.5A2.5 2.5 0 0 0 4 6.5v13z" }),
                Store: React.createElement('path', { d: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9zM9 22V12h6v10" }),
                Send: React.createElement('path', { d: "m22 2-7 20-4-9-9-4Z" }),
                Printer: React.createElement('path', { d: "M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" })
            };
            return React.createElement('svg', {
                width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor",
                strokeWidth: "2.5", strokeLinecap: "round", strokeLinejoin: "round", className: className
            }, icons[name] || null);
        };

        // --- PRODUCTOS ORIGINALES COMPLETOS (AGUA ACTUALIZADA) ---
        const INITIAL_PRODUCTS = [
            { id: 1, name: "General", price: 4900, category: "Entradas", color: "bg-sky-50" },
            { id: 2, name: "Ni침os y 3ra Edad", price: 3900, category: "Entradas", color: "bg-sky-50" },
            { id: 3, name: "General BCI", price: 3675, category: "Entradas", color: "bg-cyan-50" },
            { id: 4, name: "Ni침os y 3E BCI", price: 2925, category: "Entradas", color: "bg-cyan-50" },
            { id: 5, name: "General EPV", price: 2450, category: "Entradas", color: "bg-blue-50" },
            { id: 6, name: "Ni침os y 3E EPV", price: 1950, category: "Entradas", color: "bg-blue-50" },
            { id: 7, name: "Estudiante TNE", price: 2500, category: "Entradas", color: "bg-indigo-50" },
            { id: 8, name: "Discapacidad", price: 2500, category: "Entradas", color: "bg-indigo-50" },
            { id: 9, name: "Cumplea침os", price: 2500, category: "Entradas", color: "bg-indigo-50" },
            { id: 10, name: "Reserva Alumnos", price: 2500, category: "Reservas", color: "bg-orange-50" },
            { id: 11, name: "Reserva Adultos", price: 3500, category: "Reservas", color: "bg-orange-50" },
            { id: 12, name: "Reserva Docente", price: 0, category: "Reservas", color: "bg-green-50" },
            { id: 20, name: "Tiburon XL", price: 10000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 21, name: "Tiburon Martillo", price: 10000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 22, name: "Tortuga", price: 6000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 23, name: "Foca", price: 10000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 24, name: "Ll. Tortuga", price: 3000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 25, name: "Ll. Pinguino", price: 3000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 26, name: "Ll. Tiburon", price: 6000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 27, name: "Pulpo Reversible", price: 6000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 28, name: "Mochila Raya", price: 10000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 29, name: "Mochila Sirena", price: 10000, category: "Zoovenir", color: "bg-purple-50" },
            { id: 30, name: "Ll. Ballena", price: 3500, category: "Zoovenir", color: "bg-purple-50" },
            { id: 40, name: "Coyac", price: 300, category: "Comida", color: "bg-teal-50" },
            { id: 41, name: "Chicle", price: 200, category: "Comida", color: "bg-teal-50" },
            { id: 42, name: "Flippy", price: 500, category: "Comida", color: "bg-teal-50" },
            { id: 43, name: "Loop", price: 500, category: "Comida", color: "bg-teal-50" },
            { id: 44, name: "Pa침uelos", price: 300, category: "Comida", color: "bg-teal-50" },
            { id: 45, name: "Agua Mineral", price: 1400, category: "Comida", color: "bg-teal-50" },
            { id: 46, name: "Bebida", price: 1700, category: "Comida", color: "bg-teal-50" }
        ];

        const GUIDES = ["Coni", "Teru", "Maqui", "Maca", "Ignacio", "Javier", "Scarlett", "Yessa"];

        const App = () => {
            const [currentView, setCurrentView] = useState('pos');
            const [activeCategory, setActiveCategory] = useState('Todas');
            const [cart, setCart] = useState([]);
            const [sales, setSales] = useState(() => JSON.parse(localStorage.getItem('av_sales') || '[]'));
            const [tours, setTours] = useState(() => JSON.parse(localStorage.getItem('av_tours') || '[]'));
            const [closureHistory, setClosureHistory] = useState(() => JSON.parse(localStorage.getItem('av_closures') || '[]'));
            const [searchTerm, setSearchTerm] = useState('');
            const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
            const [paymentMethod, setPaymentMethod] = useState('efectivo');
            const [cashReceived, setCashReceived] = useState('');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [selectedGuide, setSelectedGuide] = useState('');
            const [activeReportTab, setActiveReportTab] = useState('todas');
            const [showClosureHistory, setShowClosureHistory] = useState(false);

            useEffect(() => { localStorage.setItem('av_sales', JSON.stringify(sales)); }, [sales]);
            useEffect(() => { localStorage.setItem('av_tours', JSON.stringify(tours)); }, [tours]);
            useEffect(() => { localStorage.setItem('av_closures', JSON.stringify(closureHistory)); }, [closureHistory]);
            useEffect(() => { const t = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(t); }, []);

            const filteredProducts = INITIAL_PRODUCTS.filter(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
                (activeCategory === 'Todas' || p.category === activeCategory)
            );

            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

            // --- L칩gica de Reporte Segmentado ---
            const reports = useMemo(() => {
                const process = (method) => {
                    const res = {};
                    let totalEntradas = 0;
                    let totalTienda = 0;
                    INITIAL_PRODUCTS.forEach(p => res[p.id] = { ...p, sold: 0, rev: 0 });
                    sales.forEach(s => {
                        if (!method || s.method === method) {
                            s.items.forEach(i => {
                                if (res[i.id]) {
                                    res[i.id].sold += i.quantity;
                                    res[i.id].rev += (i.price * i.quantity);
                                    if (i.category === 'Entradas' || i.category === 'Reservas') totalEntradas += (i.price * i.quantity);
                                    else totalTienda += (i.price * i.quantity);
                                }
                            });
                        }
                    });
                    const allItems = Object.values(res);
                    return {
                        entradasItems: allItems.filter(i => (i.category === 'Entradas' || i.category === 'Reservas') && i.sold > 0),
                        tiendaItems: allItems.filter(i => (i.category === 'Zoovenir' || i.category === 'Comida') && i.sold > 0),
                        totalEntradas, totalTienda
                    };
                };
                return { todas: process(null), efectivo: process('efectivo'), debito: process('debito') };
            }, [sales]);

            // --- L칩gica de agendamiento robusta para GitHub ---
            const formatHHMM = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            const roundTo5 = (date) => {
                const m = date.getMinutes(), rounded = Math.ceil(m / 5) * 5, newD = new Date(date);
                newD.setMinutes(rounded, 0, 0); return newD;
            };

            const handleCreateTour = (wsp) => {
                if (!selectedGuide) return;
                const now = new Date();
                let start;
                if (tours.length === 0) {
                    start = roundTo5(new Date(now.getTime() + 15 * 60000));
                } else {
                    const last = tours[0];
                    const parts = last.startTime.split(':');
                    const lastD = new Date(); lastD.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
                    start = roundTo5(new Date(lastD.getTime() + 15 * 60000));
                    const minSafe = roundTo5(new Date(now.getTime() + 15 * 60000));
                    if (start < minSafe) start = minSafe;
                }
                const end = new Date(start.getTime() + 30 * 60000);
                const sStr = formatHHMM(start), eStr = formatHHMM(end);
                const newT = { id: Date.now(), guide: selectedGuide, startTime: sStr, endTime: eStr, quantity: 1 };
                setTours([newT, ...tours]);
                if (wsp) window.open(`https://wa.me/?text=${encodeURIComponent(`游깱 Recorrido ${sStr}-${eStr} con ${selectedGuide}`)}`, '_blank');
                setSelectedGuide('');
            };

            const updateTourQty = (id, delta) => setTours(prev => prev.map(t => t.id === id ? { ...t, quantity: Math.max(1, t.quantity + delta) } : t));
            const removeTour = (id) => { if (confirm("쮼liminar este recorrido?")) setTours(prev => prev.filter(t => t.id !== id)); };

            const addToCart = (p) => {
                setCart(prev => {
                    const ex = prev.find(x => x.id === p.id);
                    if (ex) return prev.map(x => x.id === p.id ? { ...x, quantity: x.quantity + 1 } : x);
                    return [...prev, { ...p, quantity: 1 }];
                });
            };

            const updateQty = (id, d) => setCart(prev => prev.map(x => x.id === id ? { ...x, quantity: Math.max(0, x.quantity + d) } : x).filter(x => x.quantity > 0));
            const finalizeSale = () => {
                const n = { id: `AV-${Date.now().toString().slice(-4)}`, time: formatHHMM(new Date()), items: [...cart], total, method: paymentMethod };
                setSales([n, ...sales]); setCart([]); setIsCheckoutOpen(false); setCashReceived('');
            };

            const resetDay = () => {
                if (confirm("쮺errar d칤a? Se guardar치 el reporte en historial.")) {
                    const closure = {
                        id: Date.now(), date: new Date().toLocaleDateString(), time: formatHHMM(new Date()),
                        total: reports.todas.totalEntradas + reports.todas.totalTienda,
                        efectivo: reports.efectivo.totalEntradas + reports.efectivo.totalTienda,
                        debito: reports.debito.totalEntradas + reports.debito.totalTienda, vts: sales.length
                    };
                    setClosureHistory([closure, ...closureHistory]); setSales([]); setTours([]); 
                }
            };

            const fmt = (v) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(v);

            return html`
                <div className="flex h-screen overflow-hidden bg-slate-100 text-slate-900 text-sm">
                    <!-- FORMATO BOLETA IMPRESI칍N (OCULTO) -->
                    <div className="ticket-print">
                        <div className="ticket-header">
                            <h2 style=${{fontWeight: 'bold', fontSize: '14pt'}}>ACUARIO VALPARA칈SO</h2>
                            <p>CIERRE DE CAJA - ${new Date().toLocaleDateString()}</p>
                            <p>HORA: ${formatHHMM(new Date())}</p>
                        </div>
                        <div className="ticket-body">
                            <p style=${{fontWeight: 'bold', borderBottom: '1px solid black', margin: '3mm 0 1mm 0'}}>ENTRADAS / RESERVAS</p>
                            ${reports[activeReportTab].entradasItems.map(p => html`<div className="ticket-row"><span>${p.sold}x ${p.name}</span><span>${fmt(p.rev)}</span></div>`)}
                            <p style=${{fontWeight: 'bold', borderBottom: '1px solid black', margin: '3mm 0 1mm 0'}}>TIENDA / COMIDA</p>
                            ${reports[activeReportTab].tiendaItems.map(p => html`<div className="ticket-row"><span>${p.sold}x ${p.name}</span><span>${fmt(p.rev)}</span></div>`)}
                        </div>
                        <div className="ticket-total">
                            <div className="ticket-row"><span>TOTAL NETO:</span><span>${fmt(reports[activeReportTab].totalEntradas + reports[activeReportTab].totalTienda)}</span></div>
                        </div>
                        <div className="ticket-footer">
                            <p>Valpara칤so Terminal VTP</p>
                            <p>춰Buen trabajo equipo!</p>
                        </div>
                    </div>

                    <aside className="w-16 lg:w-48 bg-[#001d3d] text-white flex flex-col shrink-0 z-20 shadow-xl no-print">
                        <div className="p-4 lg:p-5 mb-2 flex items-center gap-3">
                            <div className="bg-sky-500 p-1.5 rounded-lg"><${Icon} name="Waves" size=${16} /></div>
                            <h1 className="hidden lg:block font-black text-xs uppercase tracking-tight">Acuario</h1>
                        </div>
                        <nav className="flex-1 px-2 space-y-1">
                            ${[{ id: 'pos', icon: 'ShoppingCart', label: 'Vender' }, { id: 'tours', icon: 'Compass', label: 'Tours' }, { id: 'history', icon: 'History', label: 'Bit치cora' }, { id: 'reports', icon: 'BarChart3', label: 'Cierre' }].map(item => html`
                                <button key=${item.id} onClick=${() => { setCurrentView(item.id); setShowClosureHistory(false); }} className=${`w-full flex items-center justify-center lg:justify-start gap-3 p-3 rounded-xl transition-all ${currentView === item.id ? 'bg-sky-600 text-white shadow-md' : 'text-slate-400 hover:bg-white/5'}`}>
                                    <${Icon} name=${item.icon} size=${16} /><span className="hidden lg:block font-bold text-[10px]">${item.label}</span>
                                </button>
                            `)}
                        </nav>
                        <button onClick=${resetDay} className="p-4 mt-auto border-t border-white/5 text-red-400 hover:bg-red-500/10 flex items-center justify-center lg:justify-start gap-2">
                            <${Icon} name="Trash2" size=${14} /><span className="hidden lg:block text-[9px] font-black uppercase">Cerrar D칤a</span>
                        </button>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden bg-slate-50">
                        <header className="h-10 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 shadow-sm no-print">
                            <div className="text-[10px] font-bold font-mono text-slate-500 tracking-tighter">${currentTime.toLocaleTimeString()}</div>
                            <div className="text-[9px] font-black text-slate-300 uppercase tracking-widest">Valpara칤so Terminal</div>
                        </header>

                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            ${currentView === 'pos' && html`
                                <div className="flex h-full flex-col lg:flex-row animate-fade">
                                    <div className="flex-1 p-4 lg:p-5 overflow-y-auto custom-scrollbar">
                                        <div className="flex flex-col md:flex-row justify-between mb-5 gap-3">
                                            <div className="relative flex-1">
                                                <${Icon} name="Search" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size=${12} />
                                                <input type="text" placeholder="Buscar..." className="w-full pl-9 pr-4 py-1.5 bg-white border border-slate-200 rounded-lg text-xs outline-none focus:ring-2 focus:ring-sky-500/20" value=${searchTerm} onChange=${e => setSearchTerm(e.target.value)} />
                                            </div>
                                            <div className="flex gap-1 bg-slate-200/50 p-1 rounded-lg">
                                                ${['Todas', 'Entradas', 'Reservas', 'Zoovenir', 'Comida'].map(cat => html`<button key=${cat} onClick=${() => setActiveCategory(cat)} className=${`px-3 py-1 rounded-md text-[9px] font-black uppercase transition-all ${activeCategory === cat ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>${cat}</button>`)}
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-3">
                                            ${filteredProducts.map(p => html`
                                                <button key=${p.id} onClick=${() => addToCart(p)} className="product-card bg-white p-3 rounded-xl border border-slate-200 hover:border-sky-400 flex flex-col justify-between text-left group shadow-sm transition-all">
                                                    <div className="flex justify-between items-start">
                                                        <div className=${`${p.color} w-8 h-8 rounded-lg flex items-center justify-center text-sky-700 shadow-sm`}><${Icon} name=${p.category === 'Entradas' ? 'Ticket' : p.category === 'Reservas' ? 'Book' : p.category === 'Zoovenir' ? 'Gift' : 'Utensils'} size=${14} /></div>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-slate-800 text-[10px] leading-tight mb-1 line-clamp-2 uppercase">${p.name}</h3>
                                                        <p className="text-sky-600 font-black text-xs">${fmt(p.price)}</p>
                                                    </div>
                                                </button>
                                            `)}
                                        </div>
                                    </div>
                                    <div className="w-full lg:w-[260px] bg-white border-l border-slate-200 flex flex-col shrink-0 shadow-lg no-print">
                                        <div className="p-3 border-b flex justify-between items-center bg-slate-50"><h2 className="font-black text-[10px] uppercase text-slate-400">Orden</h2><button onClick=${() => setCart([])} className="text-[9px] font-bold text-red-400 uppercase">Vaciar</button></div>
                                        <div className="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                                            ${cart.map(item => html`
                                                <div key=${item.id} className="bg-slate-50 p-2 rounded-lg border border-slate-100 flex items-center gap-2 animate-fade">
                                                    <div className="flex-1 min-w-0"><p className="text-[10px] font-bold text-slate-800 truncate">${item.name}</p><p className="text-[9px] text-sky-500 font-black">${fmt(item.price)}</p></div>
                                                    <div className="flex items-center bg-white rounded border">
                                                        <button onClick=${() => updateQty(item.id, -1)} className="w-5 h-5 flex items-center justify-center text-slate-400"><${Icon} name="Minus" size=${8}/></button>
                                                        <span className="w-4 text-center text-[9px] font-black">${item.quantity}</span>
                                                        <button onClick=${() => updateQty(item.id, 1)} className="w-5 h-5 flex items-center justify-center text-slate-400"><${Icon} name="Plus" size=${8}/></button>
                                                    </div>
                                                </div>
                                            `)}
                                        </div>
                                        <div className="p-4 bg-slate-900 text-white">
                                            <div className="flex justify-between items-center mb-3"><span className="text-[9px] font-bold text-slate-400 uppercase">Total</span><span className="text-xl font-black text-sky-400">${fmt(total)}</span></div>
                                            <button onClick=${() => setIsCheckoutOpen(true)} disabled=${cart.length === 0} className="w-full bg-sky-500 py-3 rounded-lg font-black text-[10px] uppercase tracking-widest disabled:opacity-20 active:scale-95 transition-all">COBRAR</button>
                                        </div>
                                    </div>
                                </div>
                            `}

                            ${currentView === 'tours' && html`
                                <div className="p-5 animate-fade h-full max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-5 no-print">
                                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-fit">
                                        <h2 className="text-sm font-black text-slate-800 uppercase mb-4 tracking-tighter">Programar Recorrido</h2>
                                        <div className="grid grid-cols-2 gap-2 mb-6">
                                            ${GUIDES.map(g => html`<button key=${g} onClick=${() => setSelectedGuide(g)} className=${`p-2.5 rounded-lg text-center font-bold text-[10px] border-2 transition-all ${selectedGuide === g ? 'bg-sky-50 border-sky-500 text-sky-700 shadow-sm' : 'bg-slate-50 border-transparent text-slate-400 hover:bg-slate-100'}`}>${g}</button>`)}
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <button onClick=${() => handleCreateTour(false)} disabled=${!selectedGuide} className="w-full bg-slate-800 text-white py-3 rounded-lg font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all">Agendar Internamente</button>
                                            <button onClick=${() => handleCreateTour(true)} disabled=${!selectedGuide} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-black flex items-center justify-center gap-2 uppercase text-[10px] tracking-widest shadow-md active:scale-95 transition-all"><${Icon} name="Send" size=${14} /> Agendar + WhatsApp</button>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <h3 className="font-black uppercase text-[9px] text-slate-400 ml-1 tracking-widest">Turnos Hoy (30m)</h3>
                                        <div className="space-y-2 overflow-y-auto max-h-[70vh] pr-2 custom-scrollbar">
                                            ${tours.map(t => html`
                                                <div key=${t.id} className="bg-white p-3 rounded-lg border border-slate-200 flex items-center justify-between shadow-sm animate-fade">
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-sky-50 text-sky-600 p-2 rounded-md font-black text-[10px] border border-sky-100">${t.startTime}</div>
                                                        <div className="flex-1"><p className="font-black text-slate-800 text-[10px] uppercase leading-none mb-1">${t.guide}</p><p className="text-[8px] font-bold text-slate-400 uppercase leading-none">Personas: ${t.quantity}</p></div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex items-center bg-slate-100 rounded border">
                                                                <button onClick=${() => updateTourQty(t.id, -1)} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-red-500"><${Icon} name="Minus" size=${10}/></button>
                                                                <button onClick=${() => updateTourQty(t.id, 1)} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-sky-500 border-l"><${Icon} name="Plus" size=${10}/></button>
                                                            </div>
                                                            <button onClick=${() => removeTour(t.id)} className="w-6 h-6 flex items-center justify-center text-red-400 hover:bg-red-50 shadow-sm border border-red-100 rounded"><${Icon} name="Trash2" size=${12}/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `)}
                                        </div>
                                    </div>
                                </div>
                            `}

                            ${currentView === 'history' && html`
                                <div className="p-5 animate-fade h-full max-w-xl mx-auto space-y-2 no-print">
                                    <h2 className="text-sm font-black text-slate-800 uppercase mb-4 tracking-tighter uppercase">Bit치cora</h2>
                                    ${sales.map(s => html`
                                        <div key=${s.id} className="bg-white p-3 rounded-lg border border-slate-200 flex items-center justify-between shadow-sm">
                                            <div className="flex-1 min-w-0 pr-4">
                                                <div className="flex items-center gap-2 mb-0.5"><p className="text-[10px] font-black text-slate-800 leading-none">${s.time} <span className="text-slate-300 ml-1">#${s.id}</span></p><span className=${`text-[7px] font-black px-1.5 py-0.5 rounded uppercase ${s.method === 'efectivo' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}`}>${s.method}</span></div>
                                                <p className="text-[9px] text-slate-500 italic truncate">${s.items.map(i => `${i.quantity}x ${i.name}`).join(', ')}</p>
                                            </div>
                                            <p className="text-xs font-black text-slate-800 tabular-nums">${fmt(s.total)}</p>
                                        </div>
                                    `)}
                                </div>
                            `}

                            ${currentView === 'reports' && html`
                                <div className="p-5 animate-fade max-w-3xl mx-auto space-y-6">
                                    <div className="flex justify-between items-center no-print">
                                        <div className="flex items-center gap-3">
                                            <h2 className="text-sm font-black text-slate-800 uppercase tracking-tighter">Cierre de Caja</h2>
                                            <button onClick=${() => setShowClosureHistory(!showClosureHistory)} className=${`text-[8px] font-black px-3 py-1 rounded border transition-all ${showClosureHistory ? 'bg-slate-800 text-white' : 'bg-white text-slate-500 hover:bg-slate-50'}`}>${showClosureHistory ? 'VER ACTUAL' : 'HISTORIAL'}</button>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick=${() => window.print()} className="bg-white p-2 rounded-lg border text-slate-400 hover:text-sky-500"><${Icon} name="Printer" size=${14}/></button>
                                            <div className="flex bg-slate-200 p-0.5 rounded-md">
                                                ${['todas', 'efectivo', 'debito'].map(tab => html`<button key=${tab} onClick=${() => setActiveReportTab(tab)} className=${`px-3 py-1 rounded text-[8px] font-black uppercase transition-all ${activeReportTab === tab ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'}`}>${tab}</button>`)}
                                            </div>
                                        </div>
                                    </div>

                                    ${showClosureHistory ? html`
                                        <div className="space-y-2 no-print">
                                            ${closureHistory.map(c => html`
                                                <div key=${c.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                                                    <div><span className="text-[8px] font-black bg-slate-100 px-2 py-0.5 rounded uppercase">${c.date}</span><h3 className="font-black text-slate-800 mt-1 uppercase text-[10px]">Total: ${fmt(c.total)} (${c.vts} vts)</h3></div>
                                                    <div className="text-[8px] font-bold text-slate-400 uppercase text-right">Efe: ${fmt(c.efectivo)}<br/>Deb: ${fmt(c.debito)}</div>
                                                </div>
                                            `)}
                                        </div>
                                    ` : html`
                                        <div className="space-y-6 no-print">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className=${`p-5 rounded-xl text-white shadow-lg flex justify-between items-center ${activeReportTab === 'todas' ? 'bg-sky-800' : activeReportTab === 'efectivo' ? 'bg-emerald-600' : 'bg-blue-600'}`}>
                                                    <div><p className="text-[8px] font-bold uppercase opacity-70">Total Entradas (${activeReportTab})</p><h3 className="text-2xl font-black">${fmt(reports[activeReportTab].totalEntradas)}</h3></div>
                                                    <${Icon} name="Ticket" size=${24} className="opacity-30" />
                                                </div>
                                                <div className=${`p-5 rounded-xl text-white shadow-lg flex justify-between items-center ${activeReportTab === 'todas' ? 'bg-purple-800' : activeReportTab === 'efectivo' ? 'bg-emerald-700' : 'bg-blue-700'}`}>
                                                    <div><p className="text-[8px] font-bold uppercase opacity-70">Total Tienda (${activeReportTab})</p><h3 className="text-2xl font-black">${fmt(reports[activeReportTab].totalTienda)}</h3></div>
                                                    <${Icon} name="Store" size=${24} className="opacity-30" />
                                                </div>
                                            </div>
                                            <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                                <table className="w-full text-left text-[9px]"><thead className="bg-slate-50 border-b border-slate-100 font-black text-slate-400 uppercase"><tr><th className="p-3">Item</th><th className="p-3 text-center">Un.</th><th className="p-3 text-right">Monto</th></tr></thead><tbody className="divide-y divide-slate-50">
                                                    <tr className="bg-slate-100/50"><td colSpan="3" className="p-2 font-black uppercase text-[8px] text-sky-700">Entradas</td></tr>
                                                    ${reports[activeReportTab].entradasItems.map(p => html`<tr key=${p.id}><td className="p-3 uppercase text-slate-700">${p.name}</td><td className="p-3 text-center font-black">${p.sold}</td><td className="p-3 text-right font-bold">${fmt(p.rev)}</td></tr>`)}
                                                    <tr className="bg-slate-100/50"><td colSpan="3" className="p-2 font-black uppercase text-[8px] text-purple-700">Tienda</td></tr>
                                                    ${reports[activeReportTab].tiendaItems.map(p => html`<tr key=${p.id}><td className="p-3 uppercase text-slate-700">${p.name}</td><td className="p-3 text-center font-black">${p.sold}</td><td className="p-3 text-right font-bold">${fmt(p.rev)}</td></tr>`)}
                                                </tbody></table>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `}
                        </div>
                    </main>
                    
                    <!-- Modal Cobro Original -->
                    ${isCheckoutOpen && html`
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4 no-print">
                            <div className="bg-white w-full max-w-[280px] rounded-2xl shadow-2xl overflow-hidden animate-fade">
                                <div className="p-5 text-center bg-[#001d3d] text-white relative">
                                    <button onClick=${() => setIsCheckoutOpen(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white leading-none"><${Icon} name="X" size=${14} /></button>
                                    <p className="text-sky-400 text-[8px] font-black uppercase mb-1">Monto Cobro</p>
                                    <h3 className="text-4xl font-black">${fmt(total)}</h3>
                                </div>
                                <div className="p-5 space-y-4 text-center">
                                    <div className="flex gap-1 p-1 bg-slate-100 rounded-lg">
                                        <button onClick=${() => setPaymentMethod('efectivo')} className=${`flex-1 py-1.5 rounded text-[8px] font-black uppercase ${paymentMethod === 'efectivo' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>Efectivo</button>
                                        <button onClick=${() => setPaymentMethod('debito')} className=${`flex-1 py-1.5 rounded text-[8px] font-black uppercase ${paymentMethod === 'debito' ? 'bg-white shadow-sm' : 'text-slate-400'}`}>D칠bito</button>
                                    </div>
                                    ${paymentMethod === 'efectivo' && html`<div className="space-y-2 animate-fade"><input type="number" className="w-full bg-slate-50 border p-2 rounded-lg text-2xl font-black text-center outline-none focus:ring-2 focus:ring-sky-500/20" placeholder="0" value=${cashReceived} onChange=${e => setCashReceived(e.target.value)} autoFocus /><div className="p-2 rounded-lg bg-emerald-50 text-center"><p className="text-emerald-700 font-bold text-[7px] uppercase mb-1">Vuelto</p><p className="text-xl font-black text-emerald-600">${fmt(Math.max(0, (parseFloat(cashReceived) || 0) - total))}</p></div></div>`}
                                    <button onClick=${finalizeSale} disabled=${paymentMethod === 'efectivo' && (!cashReceived || parseFloat(cashReceived) < total)} className="w-full bg-sky-600 text-white py-3.5 rounded-lg font-black text-[10px] uppercase tracking-widest disabled:opacity-20 active:scale-95 transition-all shadow-lg">FINALIZAR VENTA</button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>

